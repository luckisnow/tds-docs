---
title: 广告指南
sidebar_label: 开发指南
sidebar_position: 2
---

import MultiLang from '/src/docComponents/MultiLang';
import CodeBlock from '@theme/CodeBlock';
import sdkVersions from '/src/docComponents/sdkVersions';
import Languages from '../_partials/languages.mdx';
import { Conditional } from "/src/docComponents/conditional";

## SDK 配置

可以在 [下载页](/tap-download) 获得 TapSDK，引入公告模块。

<MultiLang>

<>

Unity 模块是通过引入Android 模块后增加桥接文件打包出的 `.unitypackage`，方便以 Unity 开发的游戏直接引入。其他引擎/平台的游戏可以通过 Android 原生的方式接入，详见 Android 接入文档。

**Unity 开发环境要求**：Unity 2019.4 或更高版本


Unity **2020.3.15** 之前的版本需要升级 Gradle 版本，在 `Project Settings` -> `Player` -> `Android Tab` -> `Publish Settings` -> `Build`，然后勾选**Custom Base Gradle Template**

将以下更改应用于生成的这个文件:
**Assets/Plugins/Android/baseProjectTemplate.gradle**

如果存在，请移除文件顶部的以下注释：
``` groove
// GENERATED BY UNITY. REMOVE THIS COMMENT TO PREVENT OVERWRITING WHEN EXPORTING AGAIN
```

修改文件内容:
```groove
dependencies {
    // If you are changing the Android Gradle Plugin version, make sure it is compatible with the Gradle version preinstalled with Unity
    // See which Gradle version is preinstalled with Unity here https://docs.unity3d.com/Manual/android-gradle-overview.html
    // See official Gradle and Android Gradle Plugin compatibility table here https://developer.android.com/studio/releases/gradle-plugin#updating-gradle
    // To specify a custom Gradle version in Unity, go do "Preferences > External Tools", uncheck "Gradle Installed with Unity (recommended)" and specify a path to a custom Gradle version
    // highlight-start
    // 将 3.x.0 版本修改为4.0.1
    //classpath 'com.android.tools.build:gradle:3.x.0'
    classpath 'com.android.tools.build:gradle:4.0.1'
    // highlight-end
    **BUILD_SCRIPT_DEPS**
}
```

同时，为了将 [Gradle 版本和 Android Gradle Plugin 版本对应](https://developer.android.com/studio/releases/gradle-plugin#expandable-1)，需要更新 Gradle 版本，下载 [6.1.1 版本的 Gradle](https://services.gradle.org/distributions/gradle-6.1.1-bin.zip)，解压后放到自定义的文件夹中，同时**不**勾选 Unity 中的 `Preferences` -> `External Tools`-> `Android` -> `Gradle Installed with Unity(recommend)`，改为选择解压后 Gradle 文件夹的位置，如 <some path\>/gradle-6.1.1

接下来，无论 Unity 版本都添加一些原生依赖库：在 `Project Settings` -> `Player` -> `Android Tab` -> `Publish Settings` -> `Build`，勾选**Custom Main Gradle Template**

将以下更改应用于生成的这个文件:
**Assets/Plugins/Android/mainTemplate.gradle**

如果存在，请移除文件顶部的以下注释：
``` groove
// GENERATED BY UNITY. REMOVE THIS COMMENT TO PREVENT OVERWRITING WHEN EXPORTING AGAIN
```

修改文件内容:
```groove
dependencies {
    implementation fileTree(dir: 'libs', include: ['*.jar'])
    // highlight-start
// 加入的依赖库-开始
    implementation 'io.reactivex.rxjava2:rxandroid:2.0.1'
    implementation 'io.reactivex.rxjava2:rxjava:2.0.1'
    implementation 'com.squareup.okhttp3:okhttp:3.12.1'
    implementation "com.android.support:appcompat-v7:28.0.0"
    implementation "com.android.support:support-annotations:28.0.0"
    implementation "com.android.support:support-v4:28.0.0"
    implementation "com.github.bumptech.glide:glide:4.0.0"
    implementation 'com.android.support:recyclerview-v7:28.0.0'
// 加入的依赖库-结束
    // highlight-end
**DEPS**}
```

此外，无论 Unity 版本都需加入 Android 相关权限申请，在 `Project Settings` -> `Player` -> `Android Tab` -> `Publish Settings` -> `Build`，勾选**Custom Main Manifest**

将以下更改应用于生成的这个文件:
**Assets/Plugins/Android/AndroidManifest.xml**

如果存在，请移除文件顶部的以下注释：
``` xml
// GENERATED BY UNITY. REMOVE THIS COMMENT TO PREVENT OVERWRITING WHEN EXPORTING AGAIN
```

修改文件内容:
```xml
<?xml version="1.0" encoding="utf-8"?>
<manifest
        xmlns:android="http://schemas.android.com/apk/res/android"
        package="com.unity3d.player"
        xmlns:tools="http://schemas.android.com/tools">

    // highlight-start
    <!-- TapAd 必须的权限-开始  -->
    <!-- TargetVersion 31 及以上 通过时，需要该权限) deviceName 和下面的 BLUETOOTEH 互斥-->
    <uses-permission android:name="android.permission.BLUETOOTH_CONNECT"/>
    <!-- 广告获取坐标（经度、纬度、精度半径（米）、获取时间 毫秒）精准推送 -->
    <uses-permission android:name="android.permission.ACCESS_FINE_LOCATION"/>
    <uses-permission android:name="android.permission.ACCESS_COARSE_LOCATION"/>
    <!-- IMEI 、序列号、MEID 、IMSI 、 ICCID 等信息。TargetSdkVersion 4以及更高需要申请 -->
    <uses-permission android:name="android.permission.READ_PHONE_STATE"/>
    <!-- TapAd 必须的权限-结束  -->
    <!-- TapAd 可选择权限-开始   -->
    <!-- 获取网络状态信息   -->
    <uses-permission android:name="android.permission.ACCESS_WIFI_STATE"/> 
    <!-- 获取安装应用列表  Android 11及以上版本才需声明,Android 11以下版本无需申请 -->
    <uses-permission android:name="android.permission.QUERY_ALL_PACKAGES"/>
    <!-- （targetVersion 31 以下）deviceName 和上面的 BLUETOOTH_CONNECT 互斥-->
    <uses-permission android:name="android.permission.BLUETOOTH"/>
    <!-- 允许应用请求安装软件包 -->
    <uses-permission android:name="android.permission.REQUEST_INSTALL_PACKAGES"/>
    <!-- TapAd 可选择权限-结束   -->
    // highlight-end

    ...
```

支持版本：

- Android：最低支持 5.0

</>

<>


</>

<>


</>

</MultiLang>

## 示例

Unity 工程可在 `TapTap/TapAD/Demo` 工程中，找到示例工程来了解其实现过程，注意** Demo 工程需要到真机中才能看到效果，Editor 环境并不会实际生效**。

## 获取广告权限

在获取 imei、地理位置时，需要用户授予权限。建议先询问权限，再进行初始化工作。

<MultiLang>

<>

```cs
using TapTap.TapAd

TapAdSdk.RequestPermissionIfNecessary();
```

</>

<>

</>

<>

</>

</MultiLang>

## 初始化

如果你已经参考[快速开始](/sdk/start/quickstart/#初始化)完成了初始化，这里只需要引入公告模块，然后添加下面初始化代码中高亮的部分到项目中即可。

<MultiLang>

<>

```cs
using TapTap.TapAd

// highlight-start
TapAdConfig config = new TapAdConfig.Builder()
                .AppId(your_app_id)               // 必选参数，后台获得 AppId
                .AppName(your_app_name)     // 必选参数，后台 AppName
                .Key(your_app_key) // 必须参数，后台获得 App 加密 key
                .IsDebug(false)                 // 可选参数，是否打开debug调试信息输出：true打开、false关闭。默认false关闭
                .Version(your_app_version)       // 必须参数，版本
                .Channel(your_app_channel) // 必须参数，渠道
                .Build();
// highlight-end

// highlight-start
// CustomControllerWrapper 为实现了 TapTap.TapAd.ICustomController 的类
// highlight-end
TapAdSdk.Init(config, new CustomControllerWrapper(this));

// ICustomController 接口说明
public interface ICustomController
{
    /// 是否允许SDK主动使用地理位置信息
    bool CanUseLocation { get; }
    /// 当isCanUseLocation=false时，可传入地理位置信息，TapAd使用您传入的地理位置信息
    TapAdLocation GetTapAdLocation { get; }
    /// 是否允许SDK主动使用手机硬件参数，如：imei
    bool CanUsePhoneState { get; }
    /// 当isCanUsePhoneState=false时，可传入imei信息，TapAd使用您传入的imei信息
    string GetDevImei { get; }
    /// 是否允许SDK主动使用ACCESS_WIFI_STATE权限
    bool CanUseWifiState { get; }
    /// 是否允许SDK主动使用WRITE_EXTERNAL_STORAGE权限
    bool CanUseWriteExternal { get; }
    /// 开发者可以传入oaid
    /// 信通院OAID的相关采集——如何获取OAID：
    /// 1. 移动安全联盟官网http://www.msa-alliance.cn/
    /// 2. 信通院统一SDK下载http://msa-alliance.cn/col.jsp?id=120
    string GetDevOaid { get; }
    /// 是否允许SDK主动获取设备上应用安装列表的采集权限
    bool Alist { get; }
    /// 是否允许SDK主动获取ANDROID_ID
    bool CanUseAndroidId { get; }
    /// 用户信息（为了提高广告的推送效率，开发者可以帮助传入一些用户的画像信息）
    CustomUser ProvideCustomer();
}
/// 地理位置说
public sealed class TapAdLocation 
{
    /// 纬度
    public double latitude;
    /// 经度
    public double longitude;
    /// 精度
    public double accuracy;
    
    /// 设置经纬度
    /// <param name="latitude">纬度</param>
    /// <param name="longitude">经度</param>
    /// <param name="accuracy">精度</param>
    public TapAdLocation(double latitude, double longitude, double accuracy)
    {
        ...
    }
}
/// 用户信
public sealed class CustomUser
{
    public int realAge;
    // 0.男;1.女
    public int realSex;
    // 角色性别 0.男;1.女
    public int avatarSex;
    // 角色等级
    public int avatarLevel;
    // 是否新玩家 0.否;1.是
    public int newUserStatus;
    // 是否为付费用户 0.否;1.是
    public int payedUserStatus;
    // 是否通过新手教程 0.否;1.是
    public int beginMissionFinished;
    // 角色当前付费道具数量
    public int avatarPayedToolCnt;
}
```

</>

<>

</>

<>

</>

</MultiLang>

## 上报用户行为

TODO: 填入关于`上报用户行为`背景的描述

<MultiLang>

<>

```cs
using TapTap.TapAd

var userActions = new UserAction[3];

var jan1st1970 = new DateTime
    (1970, 1, 1, 0, 0, 0, DateTimeKind.Utc);

for (int i = 0 ; i < 3; i ++) {
    var tmp = new UserAction(actionType: i, actionTime: (long)(DateTime.UtcNow - jan1st1970).TotalMilliseconds,
                amount: i * 1000, winStatus: i % 2);
    userActions[i] = tmp;
}
// highlight-start
// CustomUserAction 为实现了 IUserAction 的类
// highlight-end
TapAdSdk.UploadUserAction(userActions, new CustomUserAction(this));

// 用户行为数据类说明
public class UserAction
{
    /// 行为动作类型,可自定义
    public int ActionType { get; }
    /// 行为发生时间（单位：秒）
    public long ActionTime { get; }
    /// 付费金额
    public int Amount{ get; }
    /// 是否胜利.0-失败;1-胜利
    public int WinStatus{ get; }

    public UserAction(int actionType, long actionTime, int amount, int winStatus) 
    {
        ...
    }
}
// 上报接口说明
public interface IUserAction
{
    /// 上报成功
    void OnSuccess();
    /// 上报失败
    /// <param name="code">错误码</param>
    /// <param name="message">信息</param>
    void OnError(int code, string message);
}
```

</>

<>

</>

<>

</>

</MultiLang>

## 开屏广告(TapSplashAd)

### 简介

开屏广告为用户在进入App时展示的全屏广告。开屏广告为一个View，宽高默认为match_parent。注意： 开屏广告view：width =屏幕宽；height需要>=75%屏幕高 ，否则会影响计费。

建议业务逻辑

    1. 上一次打开APP，缓存5个开屏广告，有顺序。
    2. 当次打开APP，先请求服务端，由服务端筛选出哪一个。如果出于离线状态，按照默认顺序出第一个。


### 获取广告
<MultiLang>

<>

```cs
using TapTap.TapAd

TapSplashAd _tapSplashAd = null;

if (TapAdSdk.IsInited == false)
{
    Debug.Log("TapAd 需要先初始化!");
    return;
}

// 释放之前的广告
if (_tapSplashAd != null)
{
    _tapSplashAd.Dispose();
    _tapSplashAd = null;
}

int adId = YOUR_AD_ID;
// create AdRequest
var request = new TapAdRequest.Builder()
    .SpaceId(adId)
    .Extra1("your_info")
    .UserId("123")
    .Build();
_tapSplashAd = new TapSplashAd(request);
// highlight-start
// SplashAdLoadListener 为实现了 ISplashAdLoadListener 的类
// highlight-end
_tapSplashAd.SetLoadListener(new SplashAdLoadListener(this));
_tapSplashAd.Load();

// Splash 加载接口说明
public interface ISplashAdLoadListener : ICommonLoadListener
{
    /// 当 Splash 加载完毕
    /// <param name="ad"></param>
    void OnSplashAdLoad(TapSplashAd ad);
}

// 通用加载接口说明
public interface ICommonLoadListener
{
    /// 加载出错回调
    /// <param name="code">错误码</param>
    /// <param name="message">错误信息</param>
    void OnError(int code, string message);
}
```

</>

<>

</>

<>

</>

</MultiLang>

### 播放

<MultiLang>

<>

```cs
using TapTap.TapAd

if (TapAdSdk.IsInited == false)
{
    Debug.Log("TapAd 需要先初始化!");
    return;
}
if (_tapSplashAd != null)
{
    // highlight-start
    // SplashInteractionListener 为实现了 ISplashAdInteractionListener 的类
    // highlight-end
    _tapSplashAd.SetInteractionListener(new SplashInteractionListener(this));
    _tapSplashAd.Show();
}
else
{
    Debug.LogErrorFormat($"[Unity::AD] 未加载好视频,无法播放!");
}

// Splash 播放回调接口说明
public interface ISplashAdInteractionListener : ICommonInteractionListener
{
    /// 点击跳过
    /// <param name="ad"></param>
    void OnAdSkip(TapSplashAd ad);
    /// 广告时间到
    /// <param name="ad"></param>
    void OnAdTimeOver(TapSplashAd ad);
}

// 通用播放回调接口说明
public interface ICommonInteractionListener
{
    
}
```

</>

<>

</>

<>

</>

</MultiLang>

## 激励视频广告(TapRewardVideoAd)

### 简介

激励视频是一种全屏播放的视频广告，用户可以在观看完整的视频后获取奖励,视频广告播放结束后会显示结束页面，引导用户进行后续动作。目前激励视频广告的表现形式为：视频播放完展示Endcard页面。

使用场景包括但不限于：
    1. 游戏等应用内观看视频广告获得游戏内金币等；
    2. 积分类应用接入；

支持的广告尺寸： 全屏横屏(宽高比16:9)、全屏竖屏(宽高比9:16)。Android端暂不支持重力旋转


### 获取广告
<MultiLang>

<>

```cs
using TapTap.TapAd

TapRewardVideoAd _tapRewardAd = null;

if (TapAdSdk.IsInited == false)
{
    Debug.Log("TapAd 需要先初始化!");
    return;
}
if (_tapRewardAd != null)
{
    _tapRewardAd.Dispose();
    _tapRewardAd = null;
}
int adId = YOUR_AD_ID;
// create AdRequest
var request = new TapAdRequest.Builder()
    .SpaceId(adId)
    .Extra1("your_info")
    .RewardName("your_reward_name")
    .RewardCount(your_reward_count)
    .UserId("123")
    .Build();
_tapRewardAd = new TapRewardVideoAd(request);
// highlight-start
// RewardVideoAdLoadListener 为实现了 IRewardVideoAdLoadListener 的类
// highlight-end
_tapRewardAd.SetLoadListener(new RewardVideoAdLoadListener(this));
_tapRewardAd.Load();

// 激励视频广告加载回调接口说明
public interface IRewardVideoAdLoadListener : ICommonLoadListener
{
    /// 当激励视频被Cache完毕
    /// <param name="ad"></param>
    void OnRewardVideoAdCached(TapRewardVideoAd ad);
    /// 当激励视频被Load完毕
    /// <param name="ad"></param>
    void OnRewardVideoAdLoad(TapRewardVideoAd ad);
}

// 通用广告加载回调接口说明
public interface ICommonLoadListener
{
    /// 加载出错回调
    /// <param name="code">错误码</param>
    /// <param name="message">错误信息</param>
    void OnError(int code, string message);
}
```

</>

<>

</>

<>

</>

</MultiLang>

### 播放

<MultiLang>

<>

```cs
using TapTap.TapAd

if (TapAdSdk.IsInited == false)
{
    Debug.Log("TapAd 需要先初始化!");
    return;
}
if (_tapRewardAd != null)
{
    // highlight-start
    // RewardVideoInteractionListener 为实现了 IRewardVideoInteractionListener 的类
    // highlight-end
    _tapRewardAd.SetInteractionListener(new RewardVideoInteractionListener(this));
    _tapRewardAd.Show();
}
else
{
    Debug.LogErrorFormat($"[Unity::AD] 未加载好视频,无法播放!");
}

// 激励视频广告播放回调接口说明
public interface IRewardVideoInteractionListener : ICommonInteractionListener
{
    /// 当广告出现
    /// <param name="ad"></param>
    void OnAdShow(TapRewardVideoAd ad);
    
    /// 当广告关闭
    /// <param name="ad"></param>
    void OnAdClose(TapRewardVideoAd ad);

    /// 当视频完成
    /// <param name="ad"></param>
    void OnVideoComplete(TapRewardVideoAd ad);

    /// 视频出错
    /// <param name="ad"></param>
    void OnVideoError(TapRewardVideoAd ad);

    /// 视频播放完毕，奖励确认可以发放
    /// <param name="ad"></param>
    /// <param name="rewardVerify"></param>
    /// <param name="rewardAmount"></param>
    /// <param name="rewardName"></param>
    /// <param name="code"></param>
    /// <param name="msg"></param>
    void OnRewardVerify(TapRewardVideoAd ad, bool rewardVerify, int rewardAmount, string rewardName, int code, string msg);
    
    /// 当跳过视频
    /// <param name="ad"></param>
    void OnSkippedVideo(TapRewardVideoAd ad);
}

// 通用广告播放回调接口说明
public interface ICommonInteractionListener
{
    
}
```

</>

<>

</>

<>

</>

</MultiLang>

## Banner广告 （TapBannerAd）

### 简介

模版渲染Banner：开发者不用自行对广告样式进行编辑和渲染，可直接调用相关接口进行广告展示。

:::tip
注意：不支持开发者在view添加按钮及对广告拦截处理
:::

### 获取广告
<MultiLang>

<>

```cs
using TapTap.TapAd

TapRewardVideoAd _tapBannerAd = null;

if (TapAdSdk.IsInited == false)
{
    Debug.Log("TapAd 需要先初始化!");
    return;
}
if (_tapBannerAd != null)
{
    _tapBannerAd.Dispose();
    _tapBannerAd = null;
}

int adId = YOUR_AD_ID;

// create AdRequest
var request = new TapAdRequest.Builder()
    .SpaceId(adId)
    .Extra1("your_info")
    .UserId("userID")
    .Build();
_tapBannerAd = new TapBannerAd(request);
// highlight-start
// BannerAdLoadListener 为实现了 IBannerAdLoadListener 的类
// highlight-end
_tapBannerAd.SetLoadListener(new BannerAdLoadListener(this));
_tapBannerAd.Load();

// banner 广告加载回调接口说明
public interface IBannerAdLoadListener : ICommonLoadListener
{
    /// 当 Banner 加载完毕
    /// <param name="ad"></param>
    void OnBannerAdLoad(TapBannerAd ad);
}

// 通用广告加载回调接口说明
public interface ICommonLoadListener
{
    /// 加载出错回调
    /// <param name="code">错误码</param>
    /// <param name="message">错误信息</param>
    void OnError(int code, string message);
}
```

</>

<>

</>

<>

</>

</MultiLang>

### 播放

<MultiLang>

<>

```cs
using TapTap.TapAd

if (TapAdSdk.IsInited == false)
{
    Debug.Log("TapAd 需要先初始化!");
    return;
}
// highlight-start
// BannerInteractionListener 为实现了 IBannerAdInteractionListener 的类
// highlight-end
if (_tapBannerAd != null)
{
    _tapBannerAd.SetInteractionListener(new BannerInteractionListener(this));
    _tapBannerAd.Show();
}
else
{
    Debug.LogErrorFormat($"[Unity::AD] 未加载好视频,无法播放!");
}

// banner 广告播放回调接口说明
public interface IBannerAdInteractionListener : ICommonInteractionListener
{
    /// 当广告关闭
    /// <param name="ad"></param>
    void OnAdClose(TapBannerAd ad);
    /// 当点击广告
    /// <param name="ad"></param>
    void OnAdClick(TapBannerAd ad);
    /// 当点击下载
    /// <param name="ad"></param>
    void OnDownloadClick(TapBannerAd ad);
}

// 通用广告播放回调接口说明
public interface ICommonInteractionListener
{
    
}
```

</>

<>

</>

<>

</>

</MultiLang>